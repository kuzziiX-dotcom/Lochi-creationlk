<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lochi Creation | Premium Neon Flower Shop</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { 
            --neon-blue: #00f3ff; 
            --neon-dark-blue: #0077ff; 
            --bg-color: #050505; 
            --card-bg: rgba(255, 255, 255, 0.03); 
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-color); 
            background-image: radial-gradient(circle at 50% 50%, #001f3f 0%, #050505 100%);
            color: white; 
            scroll-behavior: smooth; 
            overflow-x: hidden; 
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        .neon-text { color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue); }
        .neon-border { border: 1px solid var(--neon-blue); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
        .glass { background: var(--card-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); }
        
        /* Premium Buttons */
        .blue-btn { 
            background: linear-gradient(135deg, var(--neon-blue) 0%, var(--neon-dark-blue) 100%) !important; 
            color: #000 !important; 
            font-weight: 800; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .blue-btn:hover { 
            transform: scale(1.02); 
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.6); 
        }

        /* Input Styling */
        .input-group { position: relative; margin-bottom: 20px; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--neon-blue); font-size: 14px; }
        input, select, textarea { 
            width: 100%;
            background: rgba(255,255,255,0.05) !important; 
            border: 1px solid var(--glass-border) !important; 
            color: white !important; 
            padding: 12px 12px 12px 45px !important; 
            border-radius: 15px !important; 
            outline: none !important; 
            transition: 0.3s;
        }
        input:focus { border-color: var(--neon-blue) !important; background: rgba(0, 243, 255, 0.05) !important; box-shadow: 0 0 15px rgba(0, 243, 255, 0.1); }
        
        /* Auth Tabs */
        .auth-tab { transition: 0.4s; position: relative; cursor: pointer; }
        .active-tab { color: var(--neon-blue); border-bottom: 2px solid var(--neon-blue); }

        /* Ticker Animation */
        .ticker-container { background: rgba(0, 243, 255, 0.1); border-bottom: 1px solid var(--neon-blue); overflow: hidden; white-space: nowrap; padding: 10px 0; }
        .ticker-content { display: inline-block; animation: scroll-ticker 30s linear infinite; font-size: 11px; font-weight: bold; color: var(--neon-blue); }
        @keyframes scroll-ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* Scroller */
        .update-scroll::-webkit-scrollbar { height: 4px; }
        .update-scroll::-webkit-scrollbar-thumb { background: var(--neon-blue); border-radius: 10px; }
        
        .update-item { min-width: 250px; height: 350px; border-radius: 25px; overflow: hidden; position: relative; border: 1px solid var(--glass-border); transition: 0.3s; }
        .update-item:hover { border-color: var(--neon-blue); transform: translateY(-5px); }

        /* Side Menu */
        #side-menu { position: fixed; top: 0; right: -320px; width: 300px; height: 100%; background: rgba(5, 5, 5, 0.98); z-index: 2000; transition: 0.5s; border-left: 1px solid var(--neon-blue); box-shadow: -10px 0 30px rgba(0,0,0,0.5); }
        .menu-open { right: 0 !important; }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body onload="initApp()">

    <!-- AUTHENTICATION VIEW -->
    <section id="page-auth" class="min-h-screen flex items-center justify-center p-6 bg-cover bg-center">
        <div class="glass w-full max-w-md p-8 rounded-[2.5rem] neon-border text-center shadow-2xl fade-in">
            <!-- Logo Section -->
            <div class="relative inline-block mb-6">
                <div class="absolute -inset-1 bg-[#00f3ff] rounded-full blur opacity-30 animate-pulse"></div>
                <img src="https://res.cloudinary.com/deljgkppf/image/upload/v1767954170/IMG-20260109-WA0123_kegi8a.jpg" 
                     class="relative w-24 h-24 rounded-full border-2 border-[#00f3ff] object-cover mx-auto">
            </div>
            
            <h1 class="orbitron text-2xl font-bold neon-text mb-2">LOCHI CREATION</h1>
            <p class="text-xs text-gray-400 mb-8 tracking-[3px] uppercase">Elite Neon Florals</p>
            
            <!-- Custom Tabs -->
            <div class="flex justify-around mb-8 border-b border-white/10 pb-2">
                <div id="loginTabBtn" onclick="switchAuth('login')" class="auth-tab active-tab font-bold text-sm tracking-widest px-4 py-2 uppercase">Login</div>
                <div id="signupTabBtn" onclick="switchAuth('signup')" class="auth-tab font-bold text-sm tracking-widest px-4 py-2 uppercase text-gray-500">Register</div>
            </div>

            <!-- Signup Form -->
            <form id="signupForm" class="space-y-1 hidden">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="sName" placeholder="Full Name" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="sEmail" placeholder="Email Address" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-phone"></i>
                    <input type="text" id="sPhone" placeholder="Phone Number" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-map-marker-alt"></i>
                    <textarea id="sAddress" placeholder="Delivery Address" rows="2" style="padding-top: 10px !important;" required></textarea>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="sPass" placeholder="Password" required>
                </div>
                <button type="submit" class="w-full blue-btn py-4 rounded-2xl mt-4">Create Account</button>
            </form>

            <!-- Login Form -->
            <form id="loginForm" class="space-y-4">
                <div class="input-group">
                    <i class="fas fa-user-circle"></i>
                    <input type="text" id="lUser" placeholder="Email or Phone" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="lPass" placeholder="Password" required>
                </div>
                <button type="submit" class="w-full blue-btn py-4 rounded-2xl mt-4">Sign In Now</button>
                <p class="mt-6 text-[10px] text-gray-500 italic">"Glow with every petal, Bloom with Every Choice"</p>
            </form>
        </div>
    </section>

    <!-- SIDEBAR MENU -->
    <div id="side-menu" class="p-8 flex flex-col">
        <div class="flex justify-between items-center mb-10">
            <h2 class="orbitron font-bold neon-text">NAVIGATION</h2>
            <button onclick="toggleMenu()" class="text-white hover:text-[#00f3ff]"><i class="fas fa-times text-2xl"></i></button>
        </div>
        <nav class="flex flex-col gap-6">
            <button onclick="navigateTo('home'); toggleMenu()" class="text-left py-2 hover:text-[#00f3ff] transition uppercase text-xs tracking-[2px]"><i class="fas fa-home mr-3"></i> Home</button>
            <button onclick="navigateTo('history'); toggleMenu()" class="text-left py-2 hover:text-[#00f3ff] transition uppercase text-xs tracking-[2px]"><i class="fas fa-shopping-bag mr-3"></i> My Orders</button>
            <button onclick="navigateTo('service'); toggleMenu()" class="text-left py-4 bg-cyan-900/20 rounded-xl px-4 text-[#00f3ff] uppercase text-xs tracking-[2px] font-bold"><i class="fas fa-headset mr-3"></i> Customer Service</button>
            <button onclick="navigateTo('help'); toggleMenu()" class="text-left py-2 hover:text-[#00f3ff] transition uppercase text-xs tracking-[2px]"><i class="fas fa-question-circle mr-3"></i> Help Center</button>
            <button onclick="navigateTo('profile'); toggleMenu()" class="text-left py-2 hover:text-[#00f3ff] transition uppercase text-xs tracking-[2px]"><i class="fas fa-user-circle mr-3"></i> Profile</button>
        </nav>
        <button onclick="signOut()" class="mt-auto py-4 text-red-500 font-bold border border-red-500/30 rounded-2xl hover:bg-red-500/10">LOGOUT</button>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="main-app" class="hidden min-h-screen flex flex-col">
        <div class="ticker-container">
            <div id="moving-ticker" class="ticker-content uppercase">Premium Hand-crafted Neon Flowers • Same day delivery within City • Premium Packaging • Order Now!</div>
        </div>

        <nav class="p-5 glass sticky top-0 z-50 flex justify-between items-center px-8">
            <h1 class="orbitron text-xl font-bold neon-text" onclick="navigateTo('home')">LOCHI</h1>
            <div class="flex items-center gap-5">
                <button onclick="toggleMenu()" class="text-[#00f3ff] text-2xl hover:scale-110 transition"><i class="fas fa-bars-staggered"></i></button>
                <div onclick="navigateTo('profile')" class="w-10 h-10 rounded-full border-2 border-[#00f3ff] overflow-hidden bg-gray-900 cursor-pointer">
                    <img id="navProfilePic" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="w-full h-full object-cover">
                </div>
            </div>
        </nav>

        <div id="content-views">
            <!-- HOME VIEW -->
            <main id="view-home" class="p-6 fade-in">
                <div class="max-w-7xl mx-auto">
                    <h3 class="orbitron text-[10px] text-gray-500 mb-6 uppercase tracking-[4px]">Latest Creations</h3>
                    <div id="photo-updates-scroller" class="update-scroll flex overflow-x-auto gap-4 pb-6 no-scrollbar">
                        <!-- Updates -->
                    </div>

                    <h3 class="orbitron text-xl font-bold mt-10 mb-8 border-l-4 border-[#00f3ff] pl-4 uppercase tracking-widest">Store Collection</h3>
                    <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <!-- Products -->
                    </div>
                </div>
            </main>

            <!-- CUSTOMER SERVICE VIEW -->
            <main id="view-service" class="hidden p-6 fade-in h-full flex-grow">
                <div class="max-w-xl mx-auto w-full h-[550px] glass rounded-[2.5rem] flex flex-col border border-white/10 shadow-2xl overflow-hidden">
                    <div class="p-5 blue-btn text-center font-bold tracking-[2px]">CUSTOMER SERVICE</div>
                    <div id="chat-box-service" class="flex-grow p-6 overflow-y-auto space-y-4 no-scrollbar">
                        <!-- Messages are loaded here -->
                    </div>
                    <div class="p-4 flex gap-3 bg-white/5 border-t border-white/10">
                        <input type="text" id="serviceChatInput" placeholder="How can we help you?" class="flex-grow !pl-5">
                        <button onclick="sendServiceMsg()" class="blue-btn px-6 rounded-2xl"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </main>

            <!-- HELP CENTER VIEW -->
            <main id="view-help" class="hidden p-8 fade-in">
                <div class="max-w-lg mx-auto glass p-10 rounded-[3rem] text-center neon-border">
                    <h2 class="orbitron text-xl font-bold neon-text mb-8 uppercase tracking-widest">Help Center</h2>
                    <div class="space-y-6 text-left">
                        <!-- WhatsApp Link 1 -->
                        <a href="https://wa.me/94755235773?text=Can%20you%20help%20me%3F" target="_blank" class="block bg-white/5 p-5 rounded-2xl border border-white/5 hover:bg-white/10 transition">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2"><i class="fab fa-whatsapp text-green-500 mr-2"></i> WhatsApp (1)</p>
                            <p class="text-white text-sm font-bold">+94 75 523 5773</p>
                        </a>
                        <!-- WhatsApp Link 2 -->
                        <a href="https://wa.me/94722014353?text=Can%20you%20help%20me%3F" target="_blank" class="block bg-white/5 p-5 rounded-2xl border border-white/5 hover:bg-white/10 transition">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2"><i class="fab fa-whatsapp text-green-500 mr-2"></i> WhatsApp (2)</p>
                            <p class="text-white text-sm font-bold">+94 72 201 4353</p>
                        </a>
                        <!-- Telegram Link -->
                        <a href="https://t.me/+94775497858" target="_blank" class="block bg-white/5 p-5 rounded-2xl border border-white/5 hover:bg-white/10 transition">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2"><i class="fab fa-telegram text-blue-400 mr-2"></i> Telegram</p>
                            <p class="text-white text-sm font-bold">+94 77 549 7858</p>
                        </a>
                        <!-- Email Link -->
                        <a href="mailto:lochicreation@gmail.com?body=Can%20you%20help%20me%3F" class="block bg-white/5 p-5 rounded-2xl border border-white/5 hover:bg-white/10 transition">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2"><i class="fas fa-envelope text-red-400 mr-2"></i> Email Address</p>
                            <p class="text-white text-sm font-bold">lochicreation@gmail.com</p>
                        </a>
                    </div>
                    <p class="mt-8 text-[10px] text-gray-500 italic">Our support team is available 24/7 to assist you.</p>
                </div>
            </main>

            <!-- HISTORY VIEW -->
            <main id="view-history" class="hidden p-8 fade-in">
                <div class="max-w-4xl mx-auto">
                    <h2 class="orbitron text-2xl font-bold neon-text mb-10 text-center uppercase tracking-[5px]">Orders History</h2>
                    <div id="historyList" class="space-y-4"></div>
                </div>
            </main>

            <!-- PROFILE VIEW -->
            <main id="view-profile" class="hidden p-8 fade-in">
                <div class="max-w-lg mx-auto glass p-10 rounded-[3rem] text-center neon-border">
                    <div class="relative w-36 h-36 mx-auto mb-10">
                        <img id="mainProfilePic" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="w-full h-full rounded-full border-4 border-[#00f3ff] p-1 object-cover">
                        <label class="absolute bottom-1 right-1 bg-white text-black w-10 h-10 flex items-center justify-center rounded-full cursor-pointer hover:bg-cyan-400 transition">
                            <i class="fas fa-camera"></i>
                            <input type="file" class="hidden" accept="image/*" onchange="uploadUserPic(event)">
                        </label>
                    </div>
                    <div class="space-y-4">
                        <div class="input-group">
                            <i class="fas fa-user"></i>
                            <input type="text" id="editName" placeholder="Full Name">
                        </div>
                        <div class="input-group">
                            <i class="fas fa-phone"></i>
                            <input type="text" id="editPhone" readonly class="opacity-60">
                        </div>
                        <div class="input-group">
                            <i class="fas fa-map-marker-alt"></i>
                            <textarea id="editAddress" rows="2" style="padding-top: 10px !important;"></textarea>
                        </div>
                    </div>
                    <button onclick="updateProfile()" class="w-full blue-btn py-4 rounded-2xl mt-8">Save Profile</button>
                </div>
            </main>
        </div>
    </div>

    <!-- ORDERING MODAL -->
    <div id="orderModal" class="hidden fixed inset-0 z-[3000] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass w-full max-w-lg p-8 rounded-[3rem] border border-[#00f3ff]/30 shadow-[0_0_50px_rgba(0,243,255,0.1)]">
            <div id="checkoutForm">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="orbitron text-xl font-bold neon-text uppercase tracking-widest">Checkout</h2>
                    <button onclick="closeModal()" class="text-white hover:text-red-500 transition"><i class="fas fa-times-circle text-2xl"></i></button>
                </div>
                <div class="space-y-5">
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                        <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Product</p>
                        <p id="modalItemName" class="font-bold text-lg text-white"></p>
                    </div>
                    <textarea id="orderAddress" rows="2" placeholder="Confirm Delivery Address" style="padding-left: 20px !important;"></textarea>
                    
                    <div class="flex justify-between items-center bg-white/5 p-5 rounded-2xl">
                        <span class="text-sm font-bold uppercase tracking-widest">Qty</span>
                        <div class="flex items-center gap-6">
                            <button onclick="changeQty(-1)" class="w-10 h-10 glass rounded-full hover:bg-white/10 transition">-</button>
                            <span id="mQty" class="text-xl font-bold text-cyan-400">1</span>
                            <button onclick="changeQty(1)" class="w-10 h-10 glass rounded-full hover:bg-white/10 transition">+</button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center px-4 py-2 border-t border-white/10 pt-6">
                        <span class="orbitron text-gray-400">Grand Total</span>
                        <span class="text-2xl font-bold text-[#00f3ff]">Rs. <span id="mTotal">0</span></span>
                    </div>

                    <select id="mPay" onchange="updateUI()" class="!pl-5">
                        <option value="cod">Cash on Delivery</option>
                        <option value="bank">Bank Deposit (BOC)</option>
                    </select>
                    
                    <button onclick="finalizeOrder()" class="w-full blue-btn py-5 rounded-2xl mt-4 shadow-xl">Complete Order</button>
                </div>
            </div>

            <!-- BANK VIEW -->
            <div id="bankView" class="hidden text-center fade-in">
                <h3 class="font-bold text-yellow-500 mb-6 uppercase tracking-widest">Bank Details</h3>
                <div class="bg-black/40 p-6 rounded-3xl text-left text-sm mb-8 border border-white/10 leading-relaxed">
                    <p class="mb-2">Bank: <span class="text-white font-bold">Bank of Ceylon (BOC)</span></p>
                    <p class="mb-2">Account No: <span class="text-white font-bold tracking-widest">95637863</span></p>
                    <p>Name: <span class="text-white font-bold uppercase">H.V.M.PEHESARA</span></p>
                </div>
                
                <div class="mb-8">
                    <label for="bank-slip-input" class="cursor-pointer group">
                        <div class="border-2 border-dashed border-white/10 rounded-[2rem] p-8 transition-all group-hover:border-[#00f3ff] group-hover:bg-[#00f3ff]/5 bg-white/5">
                            <i class="fas fa-cloud-upload-alt text-4xl mb-4 text-gray-400 group-hover:text-[#00f3ff] transition"></i>
                            <p class="text-xs font-bold uppercase text-gray-400 group-hover:text-white transition">Upload Deposit Slip</p>
                            <p id="file-name-display" class="text-[10px] text-cyan-400 mt-4 italic font-bold"></p>
                        </div>
                        <input type="file" id="bank-slip-input" accept="image/*" class="hidden" onchange="handleSlipSelected(event)">
                    </label>
                </div>

                <button onclick="submitBankOrder()" class="w-full blue-btn py-5 rounded-2xl">SUBMIT ORDER</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATABASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAHP6jCiOZ3yBTMogJ-8lGWb26U_SfeXts",
            authDomain: "lochi-creation-bc929.firebaseapp.com",
            databaseURL: "https://lochi-creation-bc929-default-rtdb.firebaseio.com",
            projectId: "lochi-creation-bc929",
            storageBucket: "lochi-creation-bc929.firebasestorage.app",
            messagingSenderId: "636349455142",
            appId: "1:636349455142:web:01964aef83ad25fb59ffe7",
            measurementId: "G-CEKED8R26R"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let sessionUser = null;
        let allUsers = JSON.parse(localStorage.getItem('lochi_users_v101')) || [];
        let currentOrder = { item: "", price: 0, qty: 1, deliveryFee: 0 };
        let slipData = "";

        // --- AUTH LOGIC ---
        function switchAuth(mode) {
            const signupForm = document.getElementById('signupForm');
            const loginForm = document.getElementById('loginForm');
            const signupTab = document.getElementById('signupTabBtn');
            const loginTab = document.getElementById('loginTabBtn');

            if(mode === 'signup') {
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
                signupTab.classList.add('active-tab'); signupTab.classList.remove('text-gray-500');
                loginTab.classList.remove('active-tab'); loginTab.classList.add('text-gray-500');
            } else {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                signupTab.classList.remove('active-tab'); signupTab.classList.add('text-gray-500');
                loginTab.classList.add('active-tab'); loginTab.classList.remove('text-gray-500');
            }
        }

        // --- CORE FUNCTIONS ---
        function initApp() {
            const saved = localStorage.getItem('lochi_session');
            if(saved) { sessionUser = JSON.parse(saved); showMain(); }
            loadProducts(); loadUpdates(); loadTicker();
        }

        document.getElementById('signupForm').onsubmit = (e) => {
            e.preventDefault();
            const newUser = {
                name: sName.value, email: sEmail.value, phone: sPhone.value,
                address: sAddress.value, pass: sPass.value, profilePic: ""
            };
            database.ref('users/' + newUser.phone).set(newUser).then(() => {
                allUsers.push(newUser);
                localStorage.setItem('lochi_users_v101', JSON.stringify(allUsers));
                loginUser(newUser);
            });
        };

        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            const u = allUsers.find(user => (user.email === lUser.value || user.phone === lUser.value) && user.pass === lPass.value);
            if(u) loginUser(u); else alert("Invalid Credentials");
        };

        function loginUser(u) {
            sessionUser = u;
            localStorage.setItem('lochi_session', JSON.stringify(u));
            showMain();
        }

        function showMain() {
            const authPage = document.getElementById('page-auth');
            const mainApp = document.getElementById('main-app');
            if(authPage) authPage.classList.add('hidden');
            if(mainApp) mainApp.classList.remove('hidden');
            
            const navPic = document.getElementById('navProfilePic');
            const mainPic = document.getElementById('mainProfilePic');
            if(navPic) navPic.src = sessionUser.profilePic || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            if(mainPic) mainPic.src = sessionUser.profilePic || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            
            document.getElementById('editName').value = sessionUser.name;
            document.getElementById('editPhone').value = sessionUser.phone;
            document.getElementById('editAddress').value = sessionUser.address;
            navigateTo('home');
        }

        function toggleMenu() { document.getElementById('side-menu').classList.toggle('menu-open'); }

        function navigateTo(p) {
            const views = ['home', 'profile', 'history', 'service', 'help'];
            views.forEach(v => {
                const view = document.getElementById('view-' + v);
                if(view) view.classList.add('hidden');
            });
            const target = document.getElementById('view-' + p);
            if(target) target.classList.remove('hidden');
            if(p === 'history') loadHistory();
            if(p === 'service') loadServiceChat();
            window.scrollTo(0,0);
        }

        // --- DATA ---
        function loadProducts() {
            database.ref('products').on('value', snap => {
                const products = snap.val();
                let html = '';
                if(products) {
                    Object.keys(products).forEach(key => {
                        const p = products[key];
                        html += `
                        <div class="glass p-4 rounded-[2.5rem] border border-white/5 hover:border-[#00f3ff]/40 transition">
                            <img src="${p.image}" class="w-full h-40 object-cover rounded-[2rem] mb-4">
                            <p class="text-[12px] font-bold uppercase mb-1 truncate px-2">${p.name}</p>
                            <p class="text-[#00f3ff] font-bold text-lg mb-4 px-2">Rs. ${p.price}</p>
                            <button onclick="startOrder('${p.name}', ${p.price}, ${p.deliveryFee || 0})" class="w-full blue-btn py-3 rounded-2xl text-[10px]">Order Now</button>
                        </div>`;
                    });
                }
                const grid = document.getElementById('product-grid');
                if(grid) grid.innerHTML = html;
            });
        }

        function loadUpdates() {
            database.ref('updates').on('value', snap => {
                const updates = snap.val();
                let html = '';
                if(updates) {
                    Object.values(updates).forEach(u => {
                        html += `
                        <div class="update-item shadow-2xl">
                            <img src="${u.image}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                            <div class="absolute bottom-0 p-5 w-full">
                                <p class="text-[10px] text-cyan-400 font-bold italic tracking-widest">${u.caption}</p>
                            </div>
                        </div>`;
                    });
                    const scroller = document.getElementById('photo-updates-scroller');
                    if(scroller) scroller.innerHTML = html;
                }
            });
        }

        function loadTicker() {
            database.ref('updates').on('value', snap => {
                const d = snap.val();
                const ticker = document.getElementById('moving-ticker');
                if(d && ticker) ticker.innerText = Object.values(d).map(x => x.caption).join(' • ') + " • ORDER NOW VIA APP!";
            });
        }

        // --- ORDER ---
        function startOrder(name, price, fee) {
            currentOrder = { item: name, price: price, qty: 1, deliveryFee: fee };
            document.getElementById('modalItemName').innerText = name;
            document.getElementById('orderAddress').value = sessionUser.address;
            updateUI();
            document.getElementById('orderModal').classList.remove('hidden');
        }

        function changeQty(n) { currentOrder.qty = Math.max(1, currentOrder.qty + n); updateUI(); }

        function updateUI() {
            const total = (currentOrder.price * currentOrder.qty) + currentOrder.deliveryFee;
            document.getElementById('mQty').innerText = currentOrder.qty;
            document.getElementById('mTotal').innerText = total.toLocaleString();
        }

        function finalizeOrder() {
            if(document.getElementById('mPay').value === 'bank') {
                document.getElementById('checkoutForm').classList.add('hidden');
                document.getElementById('bankView').classList.remove('hidden');
            } else { saveToDb('COD', ''); }
        }

        function handleSlipSelected(e) {
            const file = e.target.files[0];
            if(file) {
                document.getElementById('file-name-display').innerText = "SELECTED: " + file.name;
                const reader = new FileReader();
                reader.onload = () => { slipData = reader.result; };
                reader.readAsDataURL(file);
            }
        }

        function submitBankOrder() {
            if(!slipData) return alert("Please upload slip");
            saveToDb('Bank Deposit', slipData);
        }

        function saveToDb(method, slip) {
            const data = {
                ...currentOrder, customer: sessionUser.name, phone: sessionUser.phone,
                address: document.getElementById('orderAddress').value,
                payment: method, slip: slip, status: 'Pending', time: new Date().toLocaleString()
            };
            database.ref('orders').push(data).then(() => {
                alert("Order Placed Successfully!");
                closeModal(); navigateTo('history');
            });
        }

        function closeModal() {
            document.getElementById('orderModal').classList.add('hidden');
            document.getElementById('checkoutForm').classList.remove('hidden');
            document.getElementById('bankView').classList.add('hidden');
            document.getElementById('file-name-display').innerText = "";
            slipData = "";
        }

        // --- HISTORY & CHAT ---
        function loadHistory() {
            database.ref('orders').orderByChild('phone').equalTo(sessionUser.phone).on('value', snap => {
                const data = snap.val();
                const list = document.getElementById('historyList');
                if(!list) return;
                if(!data) { list.innerHTML = `<p class="text-center text-gray-600">No orders found.</p>`; return; }
                list.innerHTML = Object.values(data).reverse().map(o => `
                    <div class="glass p-6 rounded-3xl flex justify-between items-center border-l-4 ${o.status === 'Pending' ? 'border-yellow-500' : 'border-green-500'}">
                        <div>
                            <p class="font-bold text-white tracking-widest">${o.item} (x${o.qty})</p>
                            <p class="text-[10px] text-gray-500 mt-1">${o.time}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-bold ${o.status === 'Pending' ? 'text-yellow-500' : 'text-green-500'} uppercase">${o.status}</p>
                            <p class="text-[10px] text-white/50 mt-1">${o.payment}</p>
                        </div>
                    </div>
                `).join('');
            });
        }

        function sendServiceMsg() {
            const input = document.getElementById('serviceChatInput');
            if(!input.value.trim()) return;
            database.ref('chats/' + sessionUser.phone).push({
                sender: 'user', text: input.value, time: new Date().toLocaleTimeString()
            });
            input.value = "";
        }

        function loadServiceChat() {
            database.ref('chats/' + sessionUser.phone).on('value', snap => {
                const msgs = snap.val();
                const container = document.getElementById('chat-box-service');
                if(!container) return;
                if(!msgs) { container.innerHTML = `<p class="bg-[#00f3ff]/10 p-4 rounded-2xl text-[12px] border border-[#00f3ff]/20">Hello ${sessionUser.name}, how can we assist you today?</p>`; return; }
                container.innerHTML = Object.values(msgs).map(m => `
                    <div class="flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}">
                        <div class="p-4 rounded-2xl max-w-[80%] text-sm ${m.sender === 'user' ? 'bg-[#0077ff] text-white rounded-br-none' : 'glass border-[#00f3ff]/30 text-white rounded-bl-none'}">
                            ${m.text}
                        </div>
                    </div>
                `).join('');
                container.scrollTop = container.scrollHeight;
            });
        }

        function uploadUserPic(e) {
            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result;
                database.ref('users/' + sessionUser.phone).update({ profilePic: base64 });
                sessionUser.profilePic = base64;
                localStorage.setItem('lochi_session', JSON.stringify(sessionUser));
                const navPic = document.getElementById('navProfilePic');
                const mainPic = document.getElementById('mainProfilePic');
                if(navPic) navPic.src = base64;
                if(mainPic) mainPic.src = base64;
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function updateProfile() {
            const update = { name: editName.value, address: editAddress.value };
            database.ref('users/' + sessionUser.phone).update(update);
            Object.assign(sessionUser, update);
            localStorage.setItem('lochi_session', JSON.stringify(sessionUser));
            alert("Profile Updated Successfully!");
        }

        function signOut() { localStorage.removeItem('lochi_session'); location.reload(); }
    </script>
</body>
</html>
