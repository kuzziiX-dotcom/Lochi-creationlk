<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lochi Creation | Premium Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --p: #ff0080; --o: #ff8c00; --bg: #0b0f19; --wa: #25D366; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: white; scroll-behavior: smooth; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .pink-gradient { background: linear-gradient(135deg, var(--p) 0%, var(--o) 100%); }
        .text-gradient { background: linear-gradient(90deg, #ff4d94, #ff99cc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden { display: none !important; }
        
        /* Status & Swiper */
        .status-ring { padding: 3px; background: linear-gradient(45deg, #25D366, #128C7E); border-radius: 50%; cursor: pointer; flex-shrink: 0; }
        .swiper { width: 100%; height: 320px; border-radius: 30px; margin-bottom: 20px; }
        
        /* Event Style */
        .event-card { min-width: 260px; height: 150px; border-radius: 20px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; cursor: pointer; }
        .event-overlay { background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); position: absolute; inset: 0; padding: 12px; display: flex; flex-direction: column; justify-content: flex-end; }

        /* Chat UI Styles */
        .msg-user { background: #056162; align-self: flex-end; border-radius: 15px 0 15px 15px; }
        .msg-admin { background: #262d31; align-self: flex-start; border-radius: 0 15px 15px 15px; }
        .chat-container { background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: contain; }

        /* Buttons */
        .cat-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 18px; border-radius: 20px; font-weight: 700; width: 100%; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; font-size: 12px; text-transform: uppercase; }
        .cat-btn:hover { border-color: var(--p); background: rgba(255, 0, 128, 0.1); transform: scale(1.02); }
    </style>
</head>
<body onload="initApp()">

    <div id="main-app" class="hidden min-h-screen flex flex-col">
        <!-- TOP NAV -->
        <nav class="p-4 glass sticky top-0 z-50 flex justify-between items-center px-6 md:px-16">
            <div class="flex items-center gap-3 cursor-pointer" onclick="navigateTo('home')">
                <img src="https://res.cloudinary.com/deljgkppf/image/upload/v1767954170/IMG-20260109-WA0123_kegi8a.jpg" class="w-10 h-10 rounded-full border border-pink-500 shadow-lg">
                <h1 class="text-xl font-black text-gradient italic">LOCHI</h1>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="navigateTo('chat')" class="text-2xl text-green-500"><i class="fab fa-whatsapp"></i></button>
                <button onclick="navigateTo('orders')" class="text-xs font-bold uppercase hover:text-pink-500">Orders</button>
                <div class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-[10px] font-bold border border-green-500/20">
                    LIVE: <span id="liveCounter">1</span>
                </div>
                <button onclick="signOut()" class="text-xs font-bold text-red-500 bg-red-500/10 px-3 py-1 rounded-lg">Logout</button>
            </div>
        </nav>

        <!-- STATUS TRAY -->
        <section id="statusTray" class="p-6 flex gap-4 overflow-x-auto no-scrollbar bg-white/5 border-b border-white/5"></section>

        <!-- EVENTS TRAY (NEW) -->
        <section class="px-6 py-4">
            <h3 class="text-[10px] font-black text-cyan-400 uppercase tracking-widest mb-3 italic">Our Upcoming Events</h3>
            <div id="eventTray" class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                <!-- Events load here -->
            </div>
        </section>

        <!-- HOME VIEW -->
        <main id="view-home" class="p-6 max-w-6xl mx-auto w-full">
            <!-- Swiper Carousel -->
            <div class="swiper mySwiper mb-10 shadow-2xl">
                <div class="swiper-wrapper" id="sliderWrapper"></div>
                <div class="swiper-pagination"></div>
            </div>

            <!-- Categories -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-16 max-w-2xl mx-auto">
                <button onclick="viewCategory('Flowers')" class="cat-btn">Flower Bouquets <i class="fas fa-chevron-right"></i></button>
                <button onclick="viewCategory('Scrunchie')" class="cat-btn">Scrunchie <i class="fas fa-chevron-right"></i></button>
                <button onclick="viewCategory('Special')" class="cat-btn">Special Flower Bouquet <i class="fas fa-chevron-right"></i></button>
                <button onclick="viewCategory('Clothes')" class="cat-btn">Clothes <i class="fas fa-chevron-right"></i></button>
            </div>

            <!-- COLLECTION GRID -->
            <h3 class="text-2xl font-black text-pink-500 border-l-4 border-pink-500 pl-4 uppercase italic mb-8">Our Collection</h3>
            <div id="homeProductGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 pb-20"></div>
        </main>

        <!-- CATEGORY VIEW -->
        <main id="view-category" class="hidden p-6 max-w-7xl mx-auto w-full">
            <div class="flex items-center gap-4 mb-8">
                <button onclick="navigateTo('home')" class="bg-white/10 p-3 rounded-full hover:bg-pink-500"><i class="fas fa-arrow-left"></i></button>
                <h2 id="catTitle" class="text-2xl font-black text-gradient uppercase italic"></h2>
            </div>
            <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 pb-20"></div>
        </main>

        <!-- (අනෙක් Views - Bank, Chat, Orders කලින් තිබූ පරිදිම පවතී) -->
        <main id="view-bank" class="hidden p-6 max-w-xl mx-auto w-full text-center">
            <div class="glass p-8 rounded-[3rem] border-pink-500/20 shadow-2xl">
                <img src="https://res.cloudinary.com/deljgkppf/image/upload/v1767945467/default_wxfeyr.jpg" class="w-full rounded-2xl mb-8 shadow-xl">
                <h2 class="text-2xl font-black text-pink-500 uppercase mb-8 italic">BOC Bank Transfer</h2>
                <div class="space-y-4 text-left bg-black/40 p-6 rounded-3xl border border-white/5 mb-8">
                    <p class="text-xs text-gray-400 font-bold uppercase">Account Number: <span class="text-white text-2xl font-black block tracking-widest mt-1">95637863</span></p>
                    <p class="text-xs text-gray-400 font-bold uppercase">Holder Name: <span class="text-white block font-bold mt-1">H.V.M.PEHESARA</span></p>
                    <p class="text-xs text-gray-400 font-bold uppercase">Bank: <span class="text-white block mt-1">Bank of Ceylon (BOC) - Galle</span></p>
                </div>
                <div class="p-6 border-2 border-dashed border-white/20 rounded-3xl text-center">
                    <label class="block cursor-pointer">
                        <input type="file" id="bankSlipInput" class="hidden" onchange="previewSlip(this)">
                        <div id="slipPreviewArea">
                            <i class="fas fa-cloud-upload-alt text-4xl mb-2 opacity-30 text-pink-500"></i>
                            <p class="text-xs font-bold text-gray-500 uppercase">Upload Pay Slip (Required)</p>
                        </div>
                    </label>
                </div>
                <button onclick="placeBankOrder()" id="bankConfirmBtn" class="hidden w-full mt-6 pink-gradient py-5 rounded-2xl font-black uppercase shadow-lg shadow-pink-500/30">Confirm Payment & Order</button>
            </div>
        </main>

        <main id="view-chat" class="hidden flex-grow flex flex-col chat-container">
            <div class="p-4 bg-[#075e54] flex items-center justify-between shadow-lg">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('home')" class="text-white mr-2"><i class="fas fa-arrow-left"></i></button>
                    <img src="https://res.cloudinary.com/deljgkppf/image/upload/v1767954170/IMG-20260109-WA0123_kegi8a.jpg" class="w-10 h-10 rounded-full border border-white/20">
                    <div><h3 class="text-white font-bold text-sm">LOCHI CREATION</h3><p class="text-[9px] text-green-300 font-bold uppercase">Support Agent Online</p></div>
                </div>
            </div>
            <div id="chatMsgs" class="flex-grow p-6 overflow-y-auto flex flex-col gap-4 no-scrollbar"></div>
            <div class="p-4 glass flex gap-3 items-center border-t border-white/10">
                <button onclick="sendLocation()" class="text-blue-400 text-xl"><i class="fas fa-map-marker-alt"></i></button>
                <input type="text" id="chatInput" placeholder="Type a message..." class="flex-grow p-3 bg-gray-900 rounded-full outline-none text-sm text-white">
                <button onclick="sendChatMessage()" class="w-12 h-12 bg-[#128c7e] rounded-full text-white shadow-lg active:scale-90 transition"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>

        <main id="view-orders" class="hidden p-6 max-w-4xl mx-auto w-full">
            <h2 class="text-2xl font-black text-center mb-10 uppercase italic">My Order Tracking</h2>
            <div id="orderHistory" class="space-y-4 pb-20"></div>
        </main>
    </div>

    <!-- EVENT MODAL (NEW) -->
    <div id="eventModal" class="hidden fixed inset-0 z-[300] bg-black/95 flex items-center justify-center p-4">
        <button onclick="closeEvent()" class="absolute top-10 right-10 text-white text-3xl"><i class="fas fa-times"></i></button>
        <div class="max-w-2xl w-full glass p-6 rounded-[2.5rem] border-white/10 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div id="eventMediaCont" class="rounded-2xl overflow-hidden mb-6 bg-black flex items-center justify-center"></div>
            <h3 id="eventFullTitle" class="text-2xl font-black text-pink-500 uppercase italic"></h3>
            <p id="eventFullDate" class="text-xs text-cyan-400 font-bold mb-4 uppercase"></p>
            <p id="eventFullDesc" class="text-sm text-gray-400 leading-relaxed"></p>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <section id="page-auth" class="min-h-screen flex items-center justify-center p-6 bg-[#0b0f19]">
        <div class="glass p-12 rounded-[4rem] w-full max-w-sm text-center border-pink-500/20 shadow-2xl">
            <img src="https://res.cloudinary.com/deljgkppf/image/upload/v1767954170/IMG-20260109-WA0123_kegi8a.jpg" class="w-24 h-24 rounded-full mx-auto mb-8 border-2 border-pink-500 shadow-2xl">
            <h2 class="text-3xl font-black mb-8 text-gradient uppercase italic tracking-tighter">LOCHI STORE</h2>
            <button onclick="signInWithGoogle()" class="w-full bg-white text-black py-4 rounded-2xl font-black mb-6 flex justify-center items-center gap-3 shadow-xl hover:bg-gray-100 transition active:scale-95">
                <img src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" class="w-5"> Login with Google
            </button>
            <p class="text-[9px] text-gray-600 font-bold uppercase tracking-widest">Premium Hand-Made Art</p>
        </div>
    </section>

    <!-- ORDER MODAL (මීට පෙර තිබූ එක එලෙසම තබා ගන්න) -->

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAHP6jCiOZ3yBTMogJ-8lGWb26U_SfeXts",
            authDomain: "lochi-creation-bc929.firebaseapp.com",
            databaseURL: "https://lochi-creation-bc929-default-rtdb.firebaseio.com",
            projectId: "lochi-creation-bc929",
            storageBucket: "lochi-creation-bc929.firebasestorage.app",
            messagingSenderId: "636349455142",
            appId: "1:636349455142:web:01964aef83ad25fb59ffe7"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentSess = null, pName = "", basePrice = 0, currentDeliFee = 0, bankSlipBase64 = "";

        function initApp() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentSess = { name: user.displayName, email: user.email, uid: user.uid };
                    document.getElementById('page-auth').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    loadSlider(); loadStatuses(); loadHomeProducts(); loadEvents(); trackPresence(); loadChat();
                } else {
                    document.getElementById('page-auth').classList.remove('hidden');
                    document.getElementById('main-app').classList.add('hidden');
                }
            });
        }

        // LOAD EVENTS (NEW)
        function loadEvents() {
            database.ref('events').on('value', s => {
                const data = s.val(); const tray = document.getElementById('eventTray');
                if(!data) { tray.parentElement.classList.add('hidden'); return; }
                tray.parentElement.classList.remove('hidden'); tray.innerHTML = "";
                Object.entries(data).reverse().forEach(([id, ev]) => {
                    tray.innerHTML += `
                    <div class="event-card" onclick="showEvent('${id}')">
                        ${ev.type === 'video' ? 
                            `<video src="${ev.media}" class="w-full h-full object-cover" muted></video>` : 
                            `<img src="${ev.media}" class="w-full h-full object-cover">`}
                        <div class="event-overlay">
                            <p class="text-[8px] font-black text-cyan-400 uppercase">${ev.date}</p>
                            <h4 class="text-xs font-bold uppercase truncate">${ev.title}</h4>
                        </div>
                    </div>`;
                });
            });
        }

        function showEvent(id) {
            database.ref('events/'+id).once('value', s => {
                const ev = s.val();
                const mediaCont = document.getElementById('eventMediaCont');
                mediaCont.innerHTML = ev.type === 'video' ? 
                    `<video src="${ev.media}" class="w-full max-h-60 object-contain" controls autoplay></video>` : 
                    `<img src="${ev.media}" class="w-full max-h-60 object-contain">`;
                document.getElementById('eventFullTitle').innerText = ev.title;
                document.getElementById('eventFullDate').innerText = ev.date;
                document.getElementById('eventFullDesc').innerText = ev.desc;
                document.getElementById('eventModal').classList.remove('hidden');
            });
        }

        function closeEvent() { document.getElementById('eventModal').classList.add('hidden'); document.getElementById('eventMediaCont').innerHTML = ""; }

        // --- (අනෙක් පරණ Functions: loadStatuses, trackPresence, viewCategory ආදිය එලෙසම තබා ගන්න) ---
        function navigateTo(v) {
            ['home', 'category', 'orders', 'bank', 'chat'].forEach(p => document.getElementById('view-' + p)?.classList.add('hidden'));
            document.getElementById('view-' + v).classList.remove('hidden');
            if(v === 'chat') loadChat();
            if(v === 'orders') loadOrderHistory();
            window.scrollTo(0,0);
        }

        function loadStatuses() {
            database.ref('status').on('value', s => {
                const data = s.val(); const tray = document.getElementById('statusTray');
                if(!data) { tray.classList.add('hidden'); return; }
                tray.classList.remove('hidden'); tray.innerHTML = "";
                const now = Date.now();
                Object.entries(data).forEach(([id, st]) => {
                    if(now - st.time > 86400000) database.ref('status/'+id).remove();
                    else tray.innerHTML += `<div class="status-ring" onclick="navigateTo('home')"><div class="w-16 h-16 rounded-full overflow-hidden border-2 border-[#0b0f19]"><img src="${st.image}" class="w-full h-full object-cover"></div></div>`;
                });
            });
        }

        function loadHomeProducts() {
            database.ref('products').on('value', s => {
                const d = s.val(); const cont = document.getElementById('homeProductGrid');
                if(!d) return;
                cont.innerHTML = Object.entries(d).reverse().map(([id, p]) => `
                <div class="glass p-5 rounded-[2.5rem] border-white/5 hover:border-pink-500/50 transition group shadow-2xl">
                    <div class="h-64 rounded-[2rem] overflow-hidden mb-4 relative shadow-lg">
                        <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                    </div>
                    <h4 class="font-black uppercase text-sm italic mb-2 tracking-tighter">${p.name}</h4>
                    <div class="flex justify-between items-center">
                        <p class="text-pink-500 font-black italic">Rs. ${p.price}</p>
                        <button onclick="openOrder('${p.name}', ${p.price}, '${p.colors}', ${p.deliFee || 0})" class="bg-pink-600 px-5 py-2 rounded-xl text-[10px] font-black uppercase active:scale-90 transition">Buy</button>
                    </div>
                </div>`).join('');
            });
        }
        
        function loadSlider() {
            database.ref('carousel').on('value', s => {
                const d = s.val(); if(!d) return;
                document.getElementById('sliderWrapper').innerHTML = Object.values(d).map(img => `<div class="swiper-slide"><img src="${img}" class="w-full h-full object-cover"></div>`).join('');
                new Swiper(".mySwiper", { pagination: { el: ".swiper-pagination", clickable: true }, autoplay: { delay: 3500 } });
            });
        }
        function trackPresence() { const u = database.ref('presence').push(true); u.onDisconnect().remove(); database.ref('presence').on('value', s => document.getElementById('liveCounter').innerText = s.numChildren()); }
        function signInWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function signOut() { auth.signOut().then(() => location.reload()); }
    </script>
</body>
</html>
