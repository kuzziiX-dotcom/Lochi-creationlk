--- START OF FILE ai_studio_code (71).html ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lochi Creation | Premium Neon Flower Shop</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* 
           LOCHI CREATION - GLOBAL STYLES
           Theme: Cyber-Neon / Futuristic Flower Shop
        */
        :root { 
            --neon-blue: #00f3ff; 
            --neon-dark-blue: #0077ff; 
            --bg-color: #050505; 
            --card-bg: rgba(255, 255, 255, 0.05); 
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        .light-mode { 
            --neon-blue: #0077ff; 
            --neon-dark-blue: #0055aa; 
            --bg-color: #f8f9fa; 
            --card-bg: rgba(0, 0, 0, 0.05); 
            --glass-border: rgba(0, 0, 0, 0.1);
            color: #1a1a1a !important; 
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-color); 
            color: white; 
            scroll-behavior: smooth; 
            overflow-x: hidden; 
            transition: background 0.3s ease;
        }

        .orbitron { font-family: 'Orbitron', sans-serif; }
        .neon-text { color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue); }
        .neon-border { border: 1px solid var(--neon-blue); box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
        .glass { background: var(--card-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); }
        
        .blue-btn { 
            background: linear-gradient(135deg, var(--neon-blue) 0%, var(--neon-dark-blue) 100%) !important; 
            color: #000 !important; 
            font-weight: bold; 
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .blue-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 243, 255, 0.5); }
        
        /* Ticker Animation */
        .ticker-container { background: rgba(0, 243, 255, 0.15); border-bottom: 1px solid var(--neon-blue); overflow: hidden; white-space: nowrap; padding: 12px 0; }
        .ticker-content { display: inline-block; animation: scroll-ticker 40s linear infinite; font-size: 13px; font-weight: 600; text-transform: uppercase; color: var(--neon-blue); }
        @keyframes scroll-ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* UI Helpers */
        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input, select, textarea { background: rgba(255,255,255,0.05) !important; border: 1px solid var(--glass-border) !important; color: inherit !important; padding: 15px !important; border-radius: 12px !important; outline: none !important; }
        input:focus { border-color: var(--neon-blue) !important; box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
        
        /* Sidebar Navigation */
        #side-menu { position: fixed; top: 0; right: -320px; width: 300px; height: 100%; background: rgba(5, 5, 5, 0.98); z-index: 2000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-left: 1px solid var(--neon-blue); }
        .menu-open { right: 0 !important; }
        
        /* Smooth Fade In */
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Update Scroller */
        .update-item { min-width: 280px; height: 380px; border-radius: 20px; overflow: hidden; position: relative; border: 1px solid var(--glass-border); flex-shrink: 0; margin-right: 15px; }
        .update-scroll { display: flex; overflow-x: auto; padding: 20px; scroll-behavior: smooth; }

        /* Chat UI */
        .chat-bubble { padding: 12px 18px; border-radius: 18px; margin-bottom: 12px; max-width: 85%; font-size: 14px; position: relative; }
        .msg-user { align-self: flex-end; background: var(--neon-dark-blue); color: white; border-bottom-right-radius: 2px; }
        .msg-admin { align-self: flex-start; background: #222; color: #fff; border-bottom-left-radius: 2px; border: 1px solid var(--neon-blue); }
    </style>
</head>
<body onload="initApp()">

    <!-- AUTHENTICATION VIEW -->
    <section id="page-auth" class="min-h-screen flex items-center justify-center p-6">
        <div class="glass w-full max-w-md p-10 rounded-[2.5rem] neon-border text-center shadow-2xl">
            <img src="https://res.cloudinary.com/deljgkppf/image/upload/v1767954170/IMG-20260109-WA0123_kegi8a.jpg" class="w-24 h-24 rounded-full mx-auto mb-6 border-2 border-[#00f3ff] shadow-lg object-cover">
            <h1 class="orbitron text-2xl font-bold neon-text mb-6">LOCHI CREATION</h1>
            
            <div class="flex mb-6 bg-white/5 rounded-2xl p-1 border border-white/10">
                <button id="signupTabBtn" onclick="switchAuth('signup')" class="flex-1 py-3 text-sm font-bold rounded-xl transition blue-btn">SIGN UP</button>
                <button id="loginTabBtn" onclick="switchAuth('login')" class="flex-1 py-3 text-sm font-bold rounded-xl transition text-gray-400">SIGN IN</button>
            </div>

            <form id="signupForm" class="space-y-4 text-left">
                <input type="text" id="sName" placeholder="Full Name" required>
                <input type="email" id="sEmail" placeholder="Email Address" required>
                <input type="text" id="sPhone" placeholder="Mobile Number" required>
                <textarea id="sAddress" placeholder="Home Address" rows="2" required></textarea>
                <input type="password" id="sPass" placeholder="Password" required>
                <button type="submit" class="w-full blue-btn py-4 rounded-xl font-bold uppercase mt-2">Get Started</button>
            </form>

            <form id="loginForm" class="space-y-4 text-left hidden">
                <input type="text" id="lUser" placeholder="Email or Phone" required>
                <input type="password" id="lPass" placeholder="Password" required>
                <button type="submit" class="w-full blue-btn py-4 rounded-xl font-bold uppercase mt-2">Login Now</button>
            </form>
        </div>
    </section>

    <!-- SIDEBAR MENU -->
    <div id="side-menu" class="p-8 flex flex-col">
        <div class="flex justify-between items-center mb-10">
            <h2 class="orbitron font-bold neon-text">NAVIGATION</h2>
            <button onclick="toggleMenu()" class="text-white hover:text-[#00f3ff]"><i class="fas fa-times text-2xl"></i></button>
        </div>
        <nav class="flex flex-col gap-5">
            <button onclick="navigateTo('home'); toggleMenu()" class="text-left py-2 border-b border-white/5 hover:text-[#00f3ff] transition uppercase text-xs tracking-widest"><i class="fas fa-home mr-3"></i> Store Home</button>
            <button onclick="navigateTo('history'); toggleMenu()" class="text-left py-2 border-b border-white/5 hover:text-[#00f3ff] transition uppercase text-xs tracking-widest"><i class="fas fa-shopping-bag mr-3"></i> My Orders</button>
            <button onclick="navigateTo('service'); toggleMenu()" class="text-left py-3 bg-cyan-900/30 rounded-lg px-2 text-[#00f3ff] uppercase text-xs tracking-widest font-bold"><i class="fas fa-headset mr-3"></i> Customer Service</button>
            <button onclick="navigateTo('profile'); toggleMenu()" class="text-left py-2 border-b border-white/5 hover:text-[#00f3ff] transition uppercase text-xs tracking-widest"><i class="fas fa-user-circle mr-3"></i> My Profile</button>
            <button onclick="navigateTo('help'); toggleMenu()" class="text-left py-2 border-b border-white/5 hover:text-[#00f3ff] transition uppercase text-xs tracking-widest"><i class="fas fa-info-circle mr-3"></i> Help & FAQ</button>
            <button onclick="navigateTo('settings'); toggleMenu()" class="text-left py-2 border-b border-white/5 hover:text-[#00f3ff] transition uppercase text-xs tracking-widest"><i class="fas fa-cog mr-3"></i> Settings</button>
        </nav>
        <button onclick="signOut()" class="mt-auto py-3 text-red-500 font-bold border border-red-500/30 rounded-xl hover:bg-red-500/10">LOGOUT</button>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="main-app" class="hidden min-h-screen flex flex-col">
        <!-- NEWS TICKER -->
        <div class="ticker-container">
            <div id="moving-ticker" class="ticker-content">Loading latest updates from Lochi Creation...</div>
        </div>

        <!-- TOP NAVIGATION -->
        <nav class="p-4 glass sticky top-0 z-50 flex justify-between items-center px-6 border-b border-white/5">
            <h1 class="orbitron text-xl font-bold neon-text" onclick="navigateTo('home')">LOCHI</h1>
            <div class="flex items-center gap-4">
                <button onclick="toggleMenu()" class="text-[#00f3ff] text-xl"><i class="fas fa-bars"></i></button>
                <div onclick="navigateTo('profile')" class="w-10 h-10 rounded-full border-2 border-[#00f3ff] overflow-hidden cursor-pointer bg-gray-800">
                    <img id="navProfilePic" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="w-full h-full object-cover">
                </div>
            </div>
        </nav>

        <!-- CONTENT AREA -->
        <div id="content-views">
            <!-- HOME VIEW -->
            <main id="view-home" class="p-6 fade-in">
                <div class="max-w-7xl mx-auto">
                    <h3 class="orbitron text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">Featured Creations</h3>
                    <div id="photo-updates-scroller" class="update-scroll">
                        <!-- Updates loaded via JS -->
                    </div>

                    <h3 class="orbitron text-xl font-bold mt-10 mb-6 border-l-4 border-[#00f3ff] pl-3 uppercase italic">Our Collection</h3>
                    <div id="product-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-8">
                        <!-- Products loaded via JS -->
                    </div>
                </div>
            </main>

            <!-- CUSTOMER SERVICE VIEW -->
            <main id="view-service" class="hidden p-6 fade-in h-full flex-grow">
                <div class="max-w-2xl mx-auto w-full h-[650px] glass rounded-[2.5rem] flex flex-col border border-white/10 shadow-2xl">
                    <div class="p-5 blue-btn text-center font-bold uppercase tracking-widest">
                        <i class="fas fa-comments mr-2"></i> Support Center
                    </div>
                    <div id="chat-box-service" class="flex-grow p-6 overflow-y-auto flex flex-col no-scrollbar">
                        <!-- Messages render here -->
                    </div>
                    <div class="p-4 flex gap-3 bg-black/20 border-t border-white/10">
                        <input type="text" id="serviceChatInput" placeholder="How can we help?" class="flex-grow">
                        <button onclick="sendServiceMsg()" class="blue-btn px-6 rounded-2xl"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </main>

            <!-- ORDER HISTORY VIEW -->
            <main id="view-history" class="hidden p-8 fade-in">
                <div class="max-w-4xl mx-auto">
                    <h2 class="orbitron text-2xl font-bold neon-text mb-8">MY ORDERS</h2>
                    <div id="historyList" class="space-y-4"></div>
                </div>
            </main>

            <!-- PROFILE VIEW -->
            <main id="view-profile" class="hidden p-8 fade-in">
                <div class="max-w-xl mx-auto glass p-10 rounded-[3rem] text-center border border-white/10">
                    <div class="relative w-32 h-32 mx-auto mb-8">
                        <img id="mainProfilePic" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="w-full h-full rounded-full border-4 border-[#00f3ff] p-1 object-cover">
                        <label class="absolute bottom-0 right-0 bg-white text-black p-2 rounded-full cursor-pointer shadow-lg hover:bg-cyan-400">
                            <i class="fas fa-camera"></i>
                            <input type="file" class="hidden" accept="image/*" onchange="uploadUserPic(event)">
                        </label>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-white/5 p-4 rounded-2xl text-left">
                            <span class="text-xs text-cyan-400 font-bold uppercase">Full Name</span>
                            <input type="text" id="editName" class="w-full bg-transparent border-none p-0 mt-1">
                        </div>
                        <div class="bg-white/5 p-4 rounded-2xl text-left">
                            <span class="text-xs text-cyan-400 font-bold uppercase">Phone Number</span>
                            <input type="text" id="editPhone" class="w-full bg-transparent border-none p-0 mt-1" readonly>
                        </div>
                        <div class="bg-white/5 p-4 rounded-2xl text-left">
                            <span class="text-xs text-cyan-400 font-bold uppercase">Address</span>
                            <textarea id="editAddress" class="w-full bg-transparent border-none p-0 mt-1"></textarea>
                        </div>
                    </div>
                    <button onclick="updateProfile()" class="w-full blue-btn py-4 rounded-2xl mt-8">UPDATE PROFILE</button>
                </div>
            </main>
        </div>

        <footer class="p-8 text-center text-gray-600 text-xs tracking-widest">
            DESIGNED BY LOCHI CREATION &copy; 2026
        </footer>
    </div>

    <!-- ORDERING MODAL -->
    <div id="orderModal" class="hidden fixed inset-0 z-[3000] bg-black/95 flex items-center justify-center p-4">
        <div class="glass w-full max-w-lg p-8 rounded-[2rem] neon-border">
            <div id="checkoutForm">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="orbitron text-xl font-bold">PLACE ORDER</h2>
                    <button onclick="closeModal()"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="space-y-4 mb-6">
                    <p class="text-xs text-gray-400 uppercase font-bold" id="modalItemName"></p>
                    <textarea id="orderAddress" rows="2" placeholder="Confirm Delivery Address"></textarea>
                    <div class="flex justify-between items-center bg-white/5 p-4 rounded-xl">
                        <span>Quantity:</span>
                        <div class="flex items-center gap-4">
                            <button onclick="changeQty(-1)" class="w-10 h-10 bg-gray-800 rounded-lg">-</button>
                            <span id="mQty" class="text-xl font-bold">1</span>
                            <button onclick="changeQty(1)" class="w-10 h-10 bg-gray-800 rounded-lg">+</button>
                        </div>
                    </div>
                    <div class="flex justify-between font-bold text-xl">
                        <span>Total Payable:</span>
                        <span class="text-[#00f3ff]">Rs. <span id="mTotal">0</span></span>
                    </div>
                </div>
                <select id="mPay" onchange="updateUI()" class="mb-6">
                    <option value="cod">Cash on Delivery</option>
                    <option value="bank">Bank Deposit (BOC)</option>
                </select>
                <button onclick="finalizeOrder()" id="finalOrderBtn" class="w-full blue-btn py-4 rounded-xl">CHECKOUT</button>
            </div>

            <div id="bankView" class="hidden text-center fade-in">
                <h3 class="font-bold text-yellow-500 mb-4 uppercase">Bank Transfer Details</h3>
                <div class="bg-black/50 p-4 rounded-xl text-left text-sm mb-6 border border-white/5">
                    <p>Bank: Bank of Ceylon (BOC)</p>
                    <p>Acc No: 95637863</p>
                    <p>Name: H.V.M.PEHESARA</p>
                </div>
                
                <!-- STYLED BANK SLIP UPLOAD -->
                <div class="mb-6">
                    <label for="bank-slip-input" class="cursor-pointer group">
                        <div class="border-2 border-dashed border-white/20 rounded-2xl p-6 transition-all group-hover:border-[#00f3ff] group-hover:bg-[#00f3ff]/5 bg-white/5">
                            <i class="fas fa-cloud-upload-alt text-3xl mb-2 text-gray-400 group-hover:text-[#00f3ff]"></i>
                            <p class="text-xs font-bold uppercase text-gray-400 group-hover:text-white">Upload Bank Slip Photo</p>
                            <p id="file-name-display" class="text-[10px] text-cyan-500 mt-2 italic font-semibold"></p>
                        </div>
                        <input type="file" id="bank-slip-input" accept="image/*" class="hidden" onchange="handleSlipSelected(event)">
                    </label>
                </div>

                <button onclick="submitBankOrder()" class="w-full blue-btn py-4 rounded-xl mt-2">SUBMIT ORDER</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATABASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAHP6jCiOZ3yBTMogJ-8lGWb26U_SfeXts",
            authDomain: "lochi-creation-bc929.firebaseapp.com",
            databaseURL: "https://lochi-creation-bc929-default-rtdb.firebaseio.com",
            projectId: "lochi-creation-bc929",
            storageBucket: "lochi-creation-bc929.firebasestorage.app",
            messagingSenderId: "636349455142",
            appId: "1:636349455142:web:01964aef83ad25fb59ffe7",
            measurementId: "G-CEKED8R26R"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let sessionUser = null;
        let allUsers = JSON.parse(localStorage.getItem('lochi_users_v101')) || [];
        let currentOrder = { item: "", price: 0, qty: 1, deliveryFee: 0 };
        let slipData = "";

        // --- CORE FUNCTIONS ---
        function initApp() {
            const saved = localStorage.getItem('lochi_session');
            if(saved) {
                sessionUser = JSON.parse(saved);
                showMain();
            }
            loadProducts();
            loadUpdates();
            loadTicker();
        }

        function switchAuth(mode) {
            document.getElementById('signupForm').classList.toggle('hidden', mode === 'login');
            document.getElementById('loginForm').classList.toggle('hidden', mode === 'signup');
            document.getElementById('signupTabBtn').style.opacity = mode === 'signup' ? '1' : '0.5';
            document.getElementById('loginTabBtn').style.opacity = mode === 'login' ? '1' : '0.5';
        }

        document.getElementById('signupForm').onsubmit = (e) => {
            e.preventDefault();
            const newUser = {
                name: sName.value,
                email: sEmail.value,
                phone: sPhone.value,
                address: sAddress.value,
                pass: sPass.value,
                profilePic: ""
            };
            database.ref('users/' + newUser.phone).set(newUser).then(() => {
                allUsers.push(newUser);
                localStorage.setItem('lochi_users_v101', JSON.stringify(allUsers));
                loginUser(newUser);
            });
        };

        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            const u = allUsers.find(user => (user.email === lUser.value || user.phone === lUser.value) && user.pass === lPass.value);
            if(u) loginUser(u); else alert("Invalid Credentials");
        };

        function loginUser(u) {
            sessionUser = u;
            localStorage.setItem('lochi_session', JSON.stringify(u));
            showMain();
        }

        function showMain() {
            document.getElementById('page-auth').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('navProfilePic').src = sessionUser.profilePic || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            document.getElementById('mainProfilePic').src = sessionUser.profilePic || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
            navigateTo('home');
        }

        function toggleMenu() { document.getElementById('side-menu').classList.toggle('menu-open'); }
        function toggleNavMenu() { const d = document.getElementById('nav-dropdown'); d.style.display = d.style.display === 'block' ? 'none' : 'block'; }

        function navigateTo(p) {
            const views = ['home', 'profile', 'history', 'help', 'service', 'settings'];
            views.forEach(v => document.getElementById('view-' + v)?.classList.add('hidden'));
            document.getElementById('view-' + p).classList.remove('hidden');
            if(p === 'history') loadHistory();
            if(p === 'service') loadServiceChat();
            window.scrollTo(0,0);
        }

        // --- DATA LOADING ---
        function loadProducts() {
            database.ref('products').on('value', snap => {
                const products = snap.val();
                let html = '';
                if(products) {
                    Object.keys(products).forEach(key => {
                        const p = products[key];
                        html += `
                        <div class="glass p-3 rounded-3xl border border-white/5">
                            <img src="${p.image}" class="w-full h-32 object-cover rounded-2xl mb-3">
                            <p class="text-[11px] font-bold uppercase truncate">${p.name}</p>
                            <p class="text-cyan-400 font-bold mb-3">Rs. ${p.price}</p>
                            <button onclick="startOrder('${p.name}', ${p.price}, ${p.deliveryFee || 0})" class="w-full blue-btn py-2 rounded-xl text-[10px]">ORDER NOW</button>
                        </div>`;
                    });
                }
                document.getElementById('product-grid').innerHTML = html;
            });
        }

        function loadUpdates() {
            database.ref('updates').on('value', snap => {
                const updates = snap.val();
                let html = '';
                if(updates) {
                    Object.keys(updates).forEach(key => {
                        const u = updates[key];
                        html += `
                        <div class="update-item shadow-2xl">
                            <img src="${u.image}" class="w-full h-full object-cover">
                            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent">
                                <p class="text-[10px] text-cyan-300 font-bold italic">${u.caption}</p>
                            </div>
                        </div>`;
                    });
                    document.getElementById('photo-updates-scroller').innerHTML = html;
                    initAutoScroll();
                }
            });
        }

        function initAutoScroll() {
            const el = document.getElementById('photo-updates-scroller');
            let scrollDir = 1;
            setInterval(() => {
                if(el) {
                    el.scrollLeft += scrollDir;
                    if(el.scrollLeft >= el.scrollWidth - el.clientWidth) scrollDir = -1;
                    if(el.scrollLeft <= 0) scrollDir = 1;
                }
            }, 30);
        }

        function loadTicker() {
            database.ref('updates').on('value', snap => {
                const d = snap.val();
                if(d) document.getElementById('moving-ticker').innerText = Object.values(d).map(x => x.caption).join(' | ');
            });
        }

        // --- ORDERING LOGIC ---
        function startOrder(name, price, fee) {
            currentOrder = { item: name, price: price, qty: 1, deliveryFee: fee };
            document.getElementById('modalItemName').innerText = name;
            document.getElementById('orderAddress').value = sessionUser.address;
            updateUI();
            document.getElementById('orderModal').classList.remove('hidden');
        }

        function changeQty(n) {
            currentOrder.qty = Math.max(1, currentOrder.qty + n);
            updateUI();
        }

        function updateUI() {
            const total = (currentOrder.price * currentOrder.qty) + currentOrder.deliveryFee;
            document.getElementById('mQty').innerText = currentOrder.qty;
            document.getElementById('mTotal').innerText = total.toLocaleString();
            currentOrder.total = total;
        }

        function finalizeOrder() {
            if(mPay.value === 'bank') {
                document.getElementById('checkoutForm').classList.add('hidden');
                document.getElementById('bankView').classList.remove('hidden');
            } else {
                saveToDb('COD', '');
            }
        }

        function handleSlipSelected(e) {
            const file = e.target.files[0];
            if(file) {
                // Show filename on screen
                document.getElementById('file-name-display').innerText = "Selected: " + file.name;
                
                const reader = new FileReader();
                reader.onload = () => { slipData = reader.result; };
                reader.readAsDataURL(file);
            }
        }

        function submitBankOrder() {
            if(!slipData) return alert("Please upload slip");
            saveToDb('Bank Deposit', slipData);
        }

        function saveToDb(method, slip) {
            const data = {
                ...currentOrder,
                customer: sessionUser.name,
                phone: sessionUser.phone,
                address: document.getElementById('orderAddress').value,
                payment: method,
                slip: slip,
                status: 'Pending',
                time: new Date().toLocaleString()
            };
            database.ref('orders').push(data).then(() => {
                alert("Order Placed Successfully!");
                closeModal();
                navigateTo('history');
            });
        }

        function closeModal() {
            document.getElementById('orderModal').classList.add('hidden');
            document.getElementById('checkoutForm').classList.remove('hidden');
            document.getElementById('bankView').classList.add('hidden');
            document.getElementById('file-name-display').innerText = ""; // Clear file name
            slipData = "";
        }

        // --- CHAT LOGIC ---
        function sendServiceMsg() {
            const input = document.getElementById('serviceChatInput');
            const txt = input.value.trim();
            if(!txt) return;
            database.ref('chats/' + sessionUser.phone).push({
                sender: 'user',
                text: txt,
                time: new Date().toLocaleTimeString()
            });
            input.value = "";
        }

        function loadServiceChat() {
            database.ref('chats/' + sessionUser.phone).on('value', snap => {
                const msgs = snap.val();
                const container = document.getElementById('chat-box-service');
                if(!msgs) {
                    container.innerHTML = `<div class="msg-admin chat-bubble">Hello ${sessionUser.name}, how can we help you?</div>`;
                    return;
                }
                container.innerHTML = Object.values(msgs).map(m => `
                    <div class="chat-bubble ${m.sender === 'user' ? 'msg-user ml-auto' : 'msg-admin'}">
                        ${m.text}
                    </div>
                `).join('');
                container.scrollTop = container.scrollHeight;
            });
        }

        function loadHistory() {
            database.ref('orders').orderByChild('phone').equalTo(sessionUser.phone).on('value', snap => {
                const data = snap.val();
                if(!data) return;
                document.getElementById('historyList').innerHTML = Object.values(data).reverse().map(o => `
                    <div class="glass p-5 rounded-2xl flex justify-between items-center">
                        <div>
                            <p class="font-bold text-sm">${o.item} (x${o.qty})</p>
                            <p class="text-[10px] text-gray-500">${o.time}</p>
                        </div>
                        <p class="text-xs font-bold text-cyan-400">${o.status}</p>
                    </div>
                `).join('');
            });
        }

        function uploadUserPic(e) {
            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result;
                database.ref('users/' + sessionUser.phone).update({ profilePic: base64 });
                sessionUser.profilePic = base64;
                localStorage.setItem('lochi_session', JSON.stringify(sessionUser));
                document.getElementById('navProfilePic').src = base64;
                document.getElementById('mainProfilePic').src = base64;
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function updateProfile() {
            const update = { name: editName.value, address: editAddress.value };
            database.ref('users/' + sessionUser.phone).update(update);
            Object.assign(sessionUser, update);
            localStorage.setItem('lochi_session', JSON.stringify(sessionUser));
            alert("Updated!");
        }

        function toggleTheme() { document.body.classList.toggle('light-mode'); }
        function signOut() { localStorage.removeItem('lochi_session'); location.reload(); }
    </script>
</body>
</html>