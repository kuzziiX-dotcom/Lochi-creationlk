<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lochi Master | Neon master panel</title>
    
    <!-- Scripts & Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --neon-blue: #00f3ff; --neon-dark: #0077ff; --neon-glow: rgba(0, 243, 255, 0.4); }
        body { background-color: #020202; color: white; font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .neon-text { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }
        .neon-border { border: 1px solid var(--neon-blue); box-shadow: 0 0 15px var(--neon-glow); }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .blue-btn { background: var(--neon-blue); color: black !important; font-weight: 900 !important; cursor: pointer; transition: 0.3s; }
        .blue-btn:hover { transform: scale(1.02); box-shadow: 0 0 25px var(--neon-blue); }
        .active-tab { border-bottom: 4px solid var(--neon-blue); color: var(--neon-blue); font-weight: bold; }
        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input, select, textarea { background: #0a0a0a !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; padding: 12px !important; border-radius: 12px !important; outline: none; width: 100%; }
        input:focus { border-color: var(--neon-blue) !important; }
    </style>
</head>
<body class="p-4 md:p-8" onload="checkAuth()">

    <!-- 1. LOGIN SECTION -->
    <div id="adminAuth" class="fixed inset-0 bg-black z-[1000] flex items-center justify-center p-6">
        <div class="glass-card p-10 rounded-[2.5rem] neon-border w-full max-w-sm text-center shadow-2xl">
            <img src="https://res.cloudinary.com/deljgkppf/image/upload/v1767954170/IMG-20260109-WA0123_kegi8a.jpg" class="w-20 h-20 rounded-full mx-auto mb-6 border-2 border-[#00f3ff] shadow-xl">
            <h2 class="orbitron text-xl font-bold neon-text mb-6 uppercase tracking-widest">Master Key</h2>
            <input type="password" id="adminPass" placeholder="Enter Password" class="text-center text-xl mb-6">
            <button onclick="login()" class="w-full blue-btn py-4 rounded-xl font-bold uppercase tracking-widest shadow-lg">Login</button>
        </div>
    </div>

    <!-- 2. MAIN PANEL -->
    <div id="adminDashboard" class="hidden">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6 sticky top-0 bg-[#020202]/90 backdrop-blur-md py-4 z-[100] border-b border-white/5">
            <div class="flex items-center gap-4">
                <img src="https://res.cloudinary.com/deljgkppf/image/upload/v1767954170/IMG-20260109-WA0123_kegi8a.jpg" class="w-12 h-12 rounded-full border border-[#00f3ff]">
                <h1 class="orbitron text-2xl font-bold neon-text italic uppercase">Admin</h1>
            </div>
            
            <div class="flex bg-white/5 rounded-full p-1 gap-1 overflow-x-auto no-scrollbar">
                <button onclick="switchTab('orders')" id="tab-orders" class="px-5 py-2 rounded-full text-[10px] active-tab">ORDERS</button>
                <button onclick="switchTab('products')" id="tab-products" class="px-5 py-2 rounded-full text-[10px] text-gray-500">MANAGE</button>
                <button onclick="switchTab('add')" id="tab-add" class="px-5 py-2 rounded-full text-[10px] text-gray-500">ADD NEW</button>
                <button onclick="switchTab('updates')" id="tab-updates" class="px-5 py-2 rounded-full text-[10px] text-gray-500">LIVE POSTS</button>
                <button onclick="switchTab('chats')" id="tab-chats" class="px-5 py-2 rounded-full text-[10px] text-gray-500">CHATS</button>
            </div>
        </header>

        <!-- VIEW: ORDERS -->
        <main id="view-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 fade-in"></main>

        <!-- VIEW: PRODUCTS (MANAGE) -->
        <main id="view-products" class="hidden grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 fade-in"></main>

        <!-- VIEW: ADD PRODUCT -->
        <main id="view-add" class="hidden max-w-lg mx-auto glass-card p-10 rounded-[3rem] neon-border">
            <h2 class="orbitron text-center text-lg font-bold neon-text mb-8 uppercase italic">Add Bouquet</h2>
            <div class="space-y-5">
                <div class="relative cursor-pointer border-2 border-dashed border-gray-700 rounded-3xl p-4 text-center hover:border-[#00f3ff]" onclick="document.getElementById('pImg').click()">
                    <img id="pPreview" src="" class="hidden w-full h-48 object-cover rounded-2xl mb-2">
                    <div id="pUploadText"><i class="fas fa-camera text-3xl mb-2 text-gray-500"></i><p class="text-[10px] font-bold">CLICK TO SELECT PHOTO</p></div>
                    <input type="file" id="pImg" class="hidden" accept="image/*" onchange="handleImgSelect(event, 'pPreview', 'pUploadText', 'product')">
                </div>
                <input type="text" id="pName" placeholder="Product Name">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="pPrice" placeholder="Price (LKR)">
                    <input type="number" id="pDeli" placeholder="Deli Fee (LKR)">
                </div>
                <select id="pCat"><option value="Mini">Mini Bouquet</option><option value="Medium">Medium Bouquet</option></select>
                <button onclick="uploadProduct()" id="addBtn" class="w-full blue-btn py-4 rounded-xl font-bold uppercase tracking-widest">Update Store Now</button>
            </div>
        </main>

        <!-- VIEW: LIVE UPDATES (NEWS POSTS) -->
        <main id="view-updates" class="hidden max-w-lg mx-auto glass-card p-10 rounded-[3rem] border border-cyan-500/30">
            <h2 class="orbitron text-center text-lg font-bold text-cyan-400 mb-8 uppercase italic">Post Live Update</h2>
            <div class="space-y-5">
                <div class="relative cursor-pointer border-2 border-dashed border-gray-700 rounded-3xl p-4 text-center hover:border-cyan-400" onclick="document.getElementById('uImg').click()">
                    <img id="uPreview" src="" class="hidden w-full h-40 object-cover rounded-2xl mb-2">
                    <div id="uUploadText"><i class="fas fa-image text-3xl mb-2 text-gray-500"></i><p class="text-[10px] font-bold uppercase">Select Post Photo</p></div>
                    <input type="file" id="uImg" class="hidden" accept="image/*" onchange="handleImgSelect(event, 'uPreview', 'uUploadText', 'news')">
                </div>
                <textarea id="uCaption" placeholder="Type caption for ticker and live feed..." rows="3"></textarea>
                <button onclick="saveLiveUpdate()" id="uBtn" class="w-full bg-cyan-600 text-black py-4 rounded-xl font-bold uppercase shadow-lg shadow-cyan-500/20">Post Update Now</button>
            </div>
            <div id="update-list-admin" class="mt-10 space-y-3 border-t border-white/5 pt-6"></div>
        </main>

        <!-- VIEW: CHATS -->
        <main id="view-chats" class="hidden max-w-5xl mx-auto flex flex-col md:flex-row gap-6 h-[75vh]">
            <div id="chatUsers" class="w-full md:w-1/3 bg-white/5 rounded-3xl p-4 overflow-y-auto no-scrollbar"></div>
            <div class="flex-grow glass-card rounded-[2.5rem] flex flex-col overflow-hidden relative shadow-2xl">
                <div id="chatWith" class="p-5 border-b border-white/5 font-bold text-xs uppercase neon-text tracking-widest bg-black/20">Select Customer</div>
                <div id="chatMsgs" class="flex-grow p-6 overflow-y-auto no-scrollbar flex flex-col gap-3 bg-[#010101]"></div>
                <div class="p-4 bg-black flex gap-3"><input type="text" id="repInput" placeholder="Reply..."><button onclick="adminSend()" class="blue-btn px-8 rounded-xl font-bold"><i class="fas fa-paper-plane"></i></button></div>
            </div>
        </main>
    </div>

    <canvas id="barcodeCanvas" style="display:none;"></canvas>
    <audio id="orderSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        const { jsPDF } = window.jspdf;
        // --- YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAHP6jCiOZ3yBTMogJ-8lGWb26U_SfeXts",
            authDomain: "lochi-creation-bc929.firebaseapp.com",
            databaseURL: "https://lochi-creation-bc929-default-rtdb.firebaseio.com",
            projectId: "lochi-creation-bc929",
            storageBucket: "lochi-creation-bc929.firebasestorage.app",
            messagingSenderId: "636349455142",
            appId: "1:636349455142:web:01964aef83ad25fb59ffe7",
            measurementId: "G-CEKED8R26R"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let curChat = "", prodBase64 = "", newsBase64 = "";

        // LOGIN
        function login() { if(adminPass.value === "lochi2026") { localStorage.setItem('lochi_master', 'true'); location.reload(); } else { alert("Wrong Key!"); } }
        function checkAuth() { if(localStorage.getItem('lochi_master')) { adminAuth.classList.add('hidden'); adminDashboard.classList.remove('hidden'); initAdmin(); } }

        function switchTab(t) {
            ['orders', 'products', 'add', 'updates', 'chats'].forEach(v => document.getElementById('view-' + v).classList.add('hidden'));
            ['tab-orders', 'tab-products', 'tab-add', 'tab-updates', 'tab-chats'].forEach(b => document.getElementById(b).classList.remove('active-tab'));
            document.getElementById('view-' + t).classList.remove('hidden');
            document.getElementById('tab-' + t).classList.add('active-tab');
        }

        // --- FIXED IMAGE HANDLER WITH COMPRESSION ---
        function handleImgSelect(e, previewId, textId, mode) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image(); img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 600; canvas.height = (img.height / img.width) * 600;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    const finalData = canvas.toDataURL('image/jpeg', 0.6);
                    if(mode === 'product') prodBase64 = finalData; else newsBase64 = finalData;
                    document.getElementById(previewId).src = finalData;
                    document.getElementById(previewId).classList.remove('hidden');
                    document.getElementById(textId).classList.add('hidden');
                };
            };
        }

        function initAdmin() {
            // Live Orders
            database.ref('orders').on('value', s => {
                const data = s.val(); if(!data) return;
                document.getElementById('view-orders').innerHTML = Object.entries(data).reverse().map(([id, o]) => `
                    <div class="glass-card p-6 rounded-[2rem] relative border border-white/10 shadow-xl">
                        <span class="absolute top-4 right-4 bg-blue-600 text-black text-[8px] px-2 py-1 rounded font-bold uppercase">${o.status}</span>
                        <h3 class="font-bold text-white uppercase text-sm mb-1">${o.item} (x${o.qty})</h3>
                        <p class="text-xl font-bold neon-text italic mb-4">Rs. ${o.total}/=</p>
                        <div class="text-[10px] text-gray-400 space-y-1 mb-6 uppercase">
                            <p>Customer: ${o.customerName}</p><p>Phone: ${o.phone}</p><p class="italic lowercase opacity-60">Addr: ${o.address}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-2 border-t border-white/5 pt-4">
                            <button onclick="updateStatus('${id}', 'Shipped')" class="bg-blue-600 text-white text-[8px] font-bold py-2 rounded-xl">SHIP</button>
                            <button onclick="updateStatus('${id}', 'Delivered')" class="bg-green-600 text-white text-[8px] font-bold py-2 rounded-xl">DONE</button>
                            <button onclick="downloadPDF('${id}', ${JSON.stringify(o).replace(/"/g, '&quot;')})" class="bg-white text-black text-[8px] font-bold py-2 rounded-xl">PDF</button>
                            <button onclick="database.ref('orders/${id}').remove()" class="bg-red-900/40 text-red-500 py-2 rounded-xl"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
                orderSound.play().catch(() => {});
            });

            // Live Manage Store
            database.ref('products').on('value', s => {
                const d = s.val(); if(!d) return;
                document.getElementById('view-products').innerHTML = Object.entries(d).reverse().map(([id, p]) => `<div class="glass-card p-4 rounded-3xl text-center border border-white/5"><img src="${p.image}" class="h-28 w-full object-cover rounded-2xl mb-3 shadow-lg"><p class="text-[9px] uppercase font-bold text-gray-300 truncate">${p.name}</p><button onclick="database.ref('products/${id}').remove()" class="text-red-500 text-[8px] font-bold underline uppercase tracking-widest mt-2">Delete</button></div>`).join('');
            });

            // Live Manage Updates
            database.ref('updates').on('value', s => {
                const d = s.val(); if(!d) return;
                document.getElementById('update-list-admin').innerHTML = Object.entries(d).reverse().map(([id, u]) => `
                    <div class="flex justify-between items-center bg-white/5 p-4 rounded-2xl border border-white/10">
                        <div class="flex items-center gap-3">
                            <img src="${u.image}" class="w-10 h-10 object-cover rounded-lg border border-cyan-500/30">
                            <span class="text-[10px] italic text-gray-400 truncate max-w-[150px]">"${u.caption}"</span>
                        </div>
                        <button onclick="database.ref('updates/${id}').remove()" class="text-red-500 font-bold uppercase text-[10px]">Delete</button>
                    </div>
                `).join('');
            });

            // Chats
            database.ref('chats').on('value', s => {
                const chats = s.val(); if(!chats) return;
                document.getElementById('chatUsers').innerHTML = Object.keys(chats).map(ph => `<div onclick="openChat('${ph}')" class="p-4 bg-white/5 rounded-2xl mb-3 cursor-pointer border-l-4 transition ${curChat === ph ? 'border-[#00f3ff] bg-cyan-600/10 text-white' : 'border-transparent text-gray-500'}"><p class="text-[10px] font-bold uppercase tracking-widest">${ph}</p></div>`).join('');
            });
        }

        // ACTIONS
        function uploadProduct() {
            if(!pName.value || !pPrice.value || !prodBase64) return alert("All details + Photo required!");
            addBtn.innerText = "UPDATING STORE..."; addBtn.disabled = true;
            database.ref('products').push({ name: pName.value, price: pPrice.value, deliveryFee: pDeli.value, category: pCat.value, image: prodBase64 }).then(() => { alert("Success!"); location.reload(); });
        }

        function saveLiveUpdate() {
            if(!uCaption.value || !newsBase64) return alert("Photo + Caption required!");
            uBtn.innerText = "POSTING..."; uBtn.disabled = true;
            database.ref('updates').push({ caption: uCaption.value, image: newsBase64, time: new Date().toLocaleDateString() }).then(() => { alert("Update Posted!"); location.reload(); });
        }

        function openChat(ph) {
            curChat = ph; chatWith.innerText = "CHAT WITH: " + ph;
            database.ref('chats/' + ph).on('value', s => {
                const m = s.val(); if(!m) return;
                document.getElementById('chatMsgs').innerHTML = Object.values(m).map(msg => `<div class="p-3 rounded-2xl max-w-[85%] text-xs shadow-lg ${msg.sender === 'admin' ? 'blue-btn self-end text-black' : 'bg-gray-800 self-start text-white'}">${msg.text}</div>`).join('');
                document.getElementById('chatMsgs').scrollTop = document.getElementById('chatMsgs').scrollHeight;
            });
        }
        function adminSend() { if(!repInput.value.trim() || !curChat) return; database.ref('chats/' + curChat).push({ sender: 'admin', text: repInput.value, time: new Date().toLocaleTimeString() }); repInput.value = ""; }
        function updateStatus(id, s) { database.ref('orders/' + id).update({ status: s }); }

        async function downloadPDF(id, o) {
            const doc = new jsPDF();
            const logo = "https://res.cloudinary.com/deljgkppf/image/upload/v1767954170/IMG-20260109-WA0123_kegi8a.jpg";
            try { const img = new Image(); img.crossOrigin = "Anonymous"; img.src = logo; await new Promise(r => img.onload = r); doc.addImage(img, 'JPEG', 85, 10, 40, 40); } catch(e) {}
            doc.setFontSize(10); doc.text("FROM: H.V.Mathish Pahasara | Dehithagama, Ginimellagaha | 077 5497858", 15, 60);
            doc.text(`DATE: ${o.time}`, 195, 66, null, null, "right"); doc.line(15, 72, 195, 72);
            doc.setFont(undefined, 'bold'); doc.text("SHIP TO: " + o.customerName.toUpperCase(), 15, 82);
            doc.setFont(undefined, 'normal'); doc.text([`Phone: ${o.phone}`, `Address: ${o.address}`], 15, 88);
            doc.line(15, 110, 195, 110); doc.text(`ORDER ITEM: ${o.item} (x${o.qty})`, 15, 120);
            doc.setFontSize(16); doc.text(`TOTAL AMOUNT: Rs. ${o.total}/=`, 15, 140);
            JsBarcode(document.getElementById("barcodeCanvas"), id.substring(1,11), { format: "CODE128" });
            doc.addImage(document.getElementById("barcodeCanvas").toDataURL(), 'PNG', 15, 165, 50, 15);
            doc.save(`Order_${o.customerName}.pdf`);
        }
    </script>
</body>
</html>