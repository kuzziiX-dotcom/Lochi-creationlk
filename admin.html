<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lochi Admin | Master Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #020617; color: white; font-family: 'Poppins', sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .pink-gradient { background: linear-gradient(135deg, #ff0080 0%, #ff8c00 100%); }
        .active-tab { background: #ff0080; border-radius: 12px; box-shadow: 0 0 20px rgba(255, 0, 128, 0.4); }
        .hidden { display: none !important; }
        .input-dark { background: #0f172a; border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; width: 100%; color: white; outline: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- LOGIN AREA (lochi2026) -->
    <div id="adminAuth" class="fixed inset-0 bg-black z-[500] flex items-center justify-center p-6">
        <div class="glass-card p-12 rounded-[4rem] w-full max-w-sm text-center shadow-2xl border-pink-500/20">
            <h2 class="text-3xl font-black text-pink-500 mb-10 italic uppercase">Master Access</h2>
            <input type="password" id="adminPass" placeholder="••••" class="input-dark text-center text-4xl mb-10 tracking-[0.5em]">
            <button onclick="checkAdmin()" class="w-full pink-gradient py-5 rounded-3xl font-black uppercase tracking-widest active:scale-95 transition shadow-xl">Unlock Panel</button>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div id="adminDashboard" class="hidden flex-grow flex flex-col">
        <header class="p-6 glass-card sticky top-0 z-[100] flex flex-col gap-4">
            <div class="flex justify-between items-center px-4">
                <h1 class="font-black italic text-pink-500 text-xl tracking-tighter uppercase">Lochi Admin</h1>
                <div class="bg-green-500/20 text-green-400 px-4 py-1 rounded-full text-[10px] font-bold border border-green-500/30">
                    LIVE: <span id="adminLiveCounter">0</span>
                </div>
            </div>
            <nav class="flex overflow-x-auto gap-2 no-scrollbar pb-1">
                <button onclick="switchTab('orders')" id="btn-orders" class="active-tab px-6 py-2 text-[10px] font-bold uppercase whitespace-nowrap">Orders</button>
                <button onclick="switchTab('upload')" id="btn-upload" class="px-6 py-2 text-[10px] font-bold uppercase whitespace-nowrap">Upload</button>
                <button onclick="switchTab('products')" id="btn-products" class="px-6 py-2 text-[10px] font-bold uppercase whitespace-nowrap">Products</button>
                <button onclick="switchTab('status')" id="btn-status" class="px-6 py-2 text-[10px] font-bold uppercase whitespace-nowrap">Status</button>
                <button onclick="switchTab('events')" id="btn-events" class="px-6 py-2 text-[10px] font-bold uppercase whitespace-nowrap text-cyan-400">Events</button>
                <button onclick="switchTab('chat')" id="btn-chat" class="px-6 py-2 text-[10px] font-bold uppercase whitespace-nowrap">Chats</button>
                <button onclick="switchTab('scanner')" id="btn-scanner" class="px-6 py-2 text-[10px] font-bold uppercase whitespace-nowrap">Scanner</button>
            </nav>
        </header>

        <!-- (කලින් තිබූ Tab-Orders, Tab-Upload, Tab-Products, Tab-Status, Tab-Chat එලෙසම පවතී) -->

        <!-- TAB: EVENTS (NEW) -->
        <main id="tab-events" class="hidden p-6 max-w-2xl mx-auto w-full">
            <div class="glass-card p-10 rounded-[3rem] space-y-4">
                <h3 class="text-xl font-bold text-cyan-400 uppercase italic">Publish New Event</h3>
                <input type="text" id="evTitle" placeholder="Event Title" class="input-dark">
                <input type="text" id="evDate" placeholder="Date (e.g. 14th Feb)" class="input-dark">
                <textarea id="evDesc" placeholder="Brief details about the event" class="input-dark" rows="3"></textarea>
                
                <input type="file" id="evMedia" class="hidden" onchange="handleEventMedia(this)">
                <label for="evMedia" class="block p-10 border-2 border-dashed border-white/20 rounded-3xl text-center cursor-pointer hover:bg-cyan-500/5 transition">
                    <div id="evPreviewArea"><i class="fas fa-video text-3xl text-cyan-400 mb-2"></i><p class="text-[10px] font-bold uppercase opacity-50">Select Photo or Video</p></div>
                </label>
                <button id="evUploadBtn" onclick="uploadEvent()" class="w-full bg-cyan-600 py-5 rounded-2xl font-black uppercase shadow-xl tracking-widest active:scale-95 transition">Publish Event</button>
            </div>
            
            <div id="adminEventList" class="mt-10 grid grid-cols-1 gap-4"></div>
        </main>

        <!-- Scanner Tab (මීට පෙර තිබූ එක එලෙසම තබා ගන්න) -->
        <main id="tab-scanner" class="hidden p-6 max-w-xl mx-auto w-full text-center">
            <div id="reader" class="rounded-3xl overflow-hidden border-2 border-blue-500/20 mb-6"></div>
            <div id="scanResult" class="hidden glass-card p-6 rounded-2xl text-left border border-blue-500/30"></div>
        </main>

        <!-- (පරණ Tabs වලට අදාළ Content එක මෙතන තියෙන්න ඕන) -->
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAHP6jCiOZ3yBTMogJ-8lGWb26U_SfeXts",
            authDomain: "lochi-creation-bc929.firebaseapp.com",
            databaseURL: "https://lochi-creation-bc929-default-rtdb.firebaseio.com",
            projectId: "lochi-creation-bc929",
            storageBucket: "lochi-creation-bc929.firebasestorage.app",
            messagingSenderId: "636349455142",
            appId: "1:636349455142:web:01964aef83ad25fb59ffe7"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const { jsPDF } = window.jspdf;

        let evMediaBase64 = "", evMediaType = "image";

        function checkAdmin() {
            if(document.getElementById('adminPass').value === "lochi2026") {
                document.getElementById('adminAuth').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                initAdmin();
            }
        }

        function switchTab(t) {
            ['orders', 'upload', 'products', 'status', 'chat', 'scanner', 'events'].forEach(id => {
                document.getElementById('tab-'+id)?.classList.add('hidden');
                document.getElementById('btn-'+id)?.classList.remove('active-tab');
            });
            document.getElementById('tab-'+t).classList.remove('hidden');
            if(document.getElementById('btn-'+t)) document.getElementById('btn-'+t).classList.add('active-tab');
            if(t === 'events') loadAdminEvents();
        }

        // EVENT LOGIC (NEW)
        function handleEventMedia(input) {
            const file = input.files[0];
            const reader = new FileReader();
            evMediaType = file.type.startsWith('video') ? 'video' : 'image';
            reader.onload = e => {
                evMediaBase64 = e.target.result;
                document.getElementById('evPreviewArea').innerHTML = evMediaType === 'video' ? 
                    `<video src="${evMediaBase64}" class="h-40 mx-auto rounded-xl shadow-xl" muted></video>` : 
                    `<img src="${evMediaBase64}" class="h-40 mx-auto rounded-xl shadow-xl">`;
            };
            reader.readAsDataURL(file);
        }

        async function uploadEvent() {
            const btn = document.getElementById('evUploadBtn');
            const title = document.getElementById('evTitle').value;
            const date = document.getElementById('evDate').value;
            const desc = document.getElementById('evDesc').value;
            if(!title || !evMediaBase64) return alert("Fill all details!");
            btn.innerText = "UPLOADING..."; btn.disabled = true;
            await database.ref('events').push({ title, date, desc, media: evMediaBase64, type: evMediaType, time: Date.now() });
            alert("Event Published!"); location.reload();
        }

        function loadAdminEvents() {
            database.ref('events').on('value', s => {
                const data = s.val(); const cont = document.getElementById('adminEventList');
                cont.innerHTML = data ? Object.entries(data).map(([id, ev]) => `
                <div class="glass-card p-4 rounded-2xl flex justify-between items-center border-white/10">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-lg overflow-hidden bg-black flex items-center justify-center">
                            ${ev.type === 'video' ? '<i class="fas fa-video text-cyan-400"></i>' : `<img src="${ev.media}" class="w-full h-full object-cover">`}
                        </div>
                        <p class="text-[10px] font-bold uppercase">${ev.title}</p>
                    </div>
                    <button onclick="database.ref('events/${id}').remove()" class="text-red-500"><i class="fas fa-trash"></i></button>
                </div>`).join('') : "";
            });
        }

        function initAdmin() {
            database.ref('presence').on('value', s => document.getElementById('adminLiveCounter').innerText = s.numChildren());
            // (කලින් තිබූ අනෙක් සියලුම initAdmin ලොජික් එලෙසම තබා ගන්න)
        }
    </script>
</body>
</html>